<header class="topbar">
    <div class="topbar-left">
        <h2 id="pageTitle">LED Durum Paneli</h2>
        <span class="breadcrumb">Ana Sayfa / LED Durum Paneli</span>
    </div>
    <div class="topbar-right">
        <div class="datetime-display">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            <span id="currentDateTime">--:--:--</span>
        </div>
        <button class="notification-btn" id="notificationBtn">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
            <span class="notification-badge" id="notificationCount">0</span>
        </button>
    </div>
</header>

<div class="dashboard-container">
    <div class="led-panel-wrapper">
        <div class="led-section">
            <div class="led-section-header">
                <h3>Input LED'ler</h3>
                <span class="led-status-badge" id="inputStatusBadge">Bekleniyor...</span>
            </div>
            <svg class="led-display" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="ledGlow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>

                <g id="inputLed1" data-led="1" data-state="off">
                    <circle cx="50" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="50" cy="60" r="12" fill="#555"/>
                    <text x="50" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 1</text>
                </g>

                <g id="inputLed2" data-led="2" data-state="off">
                    <circle cx="100" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="100" cy="60" r="12" fill="#555"/>
                    <text x="100" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 2</text>
                </g>

                <g id="inputLed3" data-led="3" data-state="off">
                    <circle cx="150" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="150" cy="60" r="12" fill="#555"/>
                    <text x="150" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 3</text>
                </g>

                <g id="inputLed4" data-led="4" data-state="off">
                    <circle cx="200" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="200" cy="60" r="12" fill="#555"/>
                    <text x="200" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 4</text>
                </g>

                <g id="inputLed5" data-led="5" data-state="off">
                    <circle cx="250" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="250" cy="60" r="12" fill="#555"/>
                    <text x="250" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 5</text>
                </g>

                <g id="inputLed6" data-led="6" data-state="off">
                    <circle cx="300" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="300" cy="60" r="12" fill="#555"/>
                    <text x="300" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 6</text>
                </g>

                <g id="inputLed7" data-led="7" data-state="off">
                    <circle cx="350" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="350" cy="60" r="12" fill="#555"/>
                    <text x="350" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 7</text>
                </g>

                <g id="inputLed8" data-led="8" data-state="off">
                    <circle cx="50" cy="20" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="50" cy="20" r="12" fill="#555"/>
                    <text x="50" y="5" text-anchor="middle" fill="#fff" font-size="12">LED 8</text>
                </g>
            </svg>
            <div class="led-info">
                <span id="inputHexValue">Hex: 0x00</span>
                <span id="inputBinaryValue">Binary: 00000000</span>
            </div>
        </div>

        <div class="led-section">
            <div class="led-section-header">
                <h3>Output LED'ler</h3>
                <span class="led-status-badge" id="outputStatusBadge">Bekleniyor...</span>
            </div>
            <svg class="led-display" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
                <g id="outputLed1" data-led="1" data-state="off">
                    <circle cx="50" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="50" cy="60" r="12" fill="#555"/>
                    <text x="50" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 1</text>
                </g>

                <g id="outputLed2" data-led="2" data-state="off">
                    <circle cx="100" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="100" cy="60" r="12" fill="#555"/>
                    <text x="100" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 2</text>
                </g>

                <g id="outputLed3" data-led="3" data-state="off">
                    <circle cx="150" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="150" cy="60" r="12" fill="#555"/>
                    <text x="150" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 3</text>
                </g>

                <g id="outputLed4" data-led="4" data-state="off">
                    <circle cx="200" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="200" cy="60" r="12" fill="#555"/>
                    <text x="200" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 4</text>
                </g>

                <g id="outputLed5" data-led="5" data-state="off">
                    <circle cx="250" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="250" cy="60" r="12" fill="#555"/>
                    <text x="250" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 5</text>
                </g>

                <g id="outputLed6" data-led="6" data-state="off">
                    <circle cx="300" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="300" cy="60" r="12" fill="#555"/>
                    <text x="300" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 6</text>
                </g>

                <g id="outputLed7" data-led="7" data-state="off">
                    <circle cx="350" cy="60" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="350" cy="60" r="12" fill="#555"/>
                    <text x="350" y="95" text-anchor="middle" fill="#fff" font-size="12">LED 7</text>
                </g>

                <g id="outputLed8" data-led="8" data-state="off">
                    <circle cx="50" cy="20" r="18" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
                    <circle class="led-core" cx="50" cy="20" r="12" fill="#555"/>
                    <text x="50" y="5" text-anchor="middle" fill="#fff" font-size="12">LED 8</text>
                </g>
            </svg>
            <div class="led-info">
                <span id="outputHexValue">Hex: 0x00</span>
                <span id="outputBinaryValue">Binary: 00000000</span>
            </div>
        </div>
    </div>

    <div class="led-controls">
        <button class="btn btn-primary" id="refreshLedBtn">
            <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            LED Durumunu Güncelle
        </button>
        <div class="auto-refresh-toggle">
            <label class="switch">
                <input type="checkbox" id="autoRefreshToggle" checked>
                <span class="slider"></span>
            </label>
            <span>Otomatik Güncelleme (1 saniye)</span>
        </div>
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot"></span>
            <span class="status-text">Bağlantı bekleniyor...</span>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.led-panel-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.led-section {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    border: 1px solid #3a3a3a;
}

.led-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.led-section-header h3 {
    color: #fff;
    font-size: 18px;
    margin: 0;
    font-weight: 600;
}

.led-status-badge {
    background: #3a3a3a;
    color: #aaa;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.led-status-badge.active {
    background: #00aa44;
    color: #fff;
}

.led-display {
    width: 100%;
    height: auto;
    background: #0a0a0a;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.led-display g {
    cursor: pointer;
    transition: all 0.3s ease;
}

.led-display g[data-state="on"] circle:first-child {
    fill: #00ff00;
    stroke: #00ff00;
    filter: url(#ledGlow);
}

.led-display g[data-state="on"] .led-core {
    fill: #00ff00;
    filter: brightness(1.5);
}

.led-display g[data-state="off"] circle:first-child {
    fill: #2a2a2a;
    stroke: #444;
}

.led-display g[data-state="off"] .led-core {
    fill: #555;
}

.led-info {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    background: #0a0a0a;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #0f0;
}

.led-controls {
    background: #1a1a1a;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    border: 1px solid #3a3a3a;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #0052a3 0%, #003d7a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
}

.auto-refresh-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #fff;
    font-size: 14px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #444;
    transition: 0.3s;
    border-radius: 26px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #00aa44;
}

input:checked + .slider:before {
    transform: translateX(24px);
}

.connection-status {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #aaa;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #666;
    animation: pulse 2s infinite;
}

.connection-status.connected .status-dot {
    background: #00aa44;
}

.connection-status.error .status-dot {
    background: #ff3333;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@media (max-width: 1200px) {
    .led-panel-wrapper {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .led-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .connection-status {
        margin-left: 0;
    }
}
</style>

<script>
let autoRefreshInterval = null;
let isAutoRefreshEnabled = true;

function parseLEDData(data) {
    const match = data.match(/L:0x([0-9A-Fa-f]{2})0x([0-9A-Fa-f]{2})/);
    if (!match) {
        console.error('Invalid LED data format:', data);
        return null;
    }

    return {
        input: parseInt(match[1], 16),
        output: parseInt(match[2], 16)
    };
}

function updateLEDs(type, value) {
    const prefix = type === 'input' ? 'input' : 'output';

    for (let i = 1; i <= 8; i++) {
        const ledElement = document.getElementById(`${prefix}Led${i}`);
        const bitMask = 1 << (i - 1);
        const isOn = (value & bitMask) !== 0;

        if (ledElement) {
            ledElement.setAttribute('data-state', isOn ? 'on' : 'off');
        }
    }

    const hexElement = document.getElementById(`${prefix}HexValue`);
    const binaryElement = document.getElementById(`${prefix}BinaryValue`);

    if (hexElement) {
        hexElement.textContent = `Hex: 0x${value.toString(16).toUpperCase().padStart(2, '0')}`;
    }

    if (binaryElement) {
        binaryElement.textContent = `Binary: ${value.toString(2).padStart(8, '0')}`;
    }
}

async function fetchLEDStatus() {
    try {
        const response = await fetch('/api/uart/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: 'command=LN'
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();

        if (data.success && data.response) {
            const ledData = parseLEDData(data.response);

            if (ledData) {
                updateLEDs('input', ledData.input);
                updateLEDs('output', ledData.output);

                document.getElementById('inputStatusBadge').textContent = 'Aktif';
                document.getElementById('inputStatusBadge').classList.add('active');
                document.getElementById('outputStatusBadge').textContent = 'Aktif';
                document.getElementById('outputStatusBadge').classList.add('active');

                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.querySelector('#connectionStatus .status-text').textContent = 'Bağlantı aktif';
            }
        } else {
            throw new Error('Invalid response data');
        }
    } catch (error) {
        console.error('LED status fetch error:', error);
        document.getElementById('connectionStatus').className = 'connection-status error';
        document.querySelector('#connectionStatus .status-text').textContent = 'Bağlantı hatası';
    }
}

function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }

    if (isAutoRefreshEnabled) {
        fetchLEDStatus();
        autoRefreshInterval = setInterval(fetchLEDStatus, 1000);
    }
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshLedBtn');
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');

    if (refreshBtn) {
        refreshBtn.addEventListener('click', fetchLEDStatus);
    }

    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            isAutoRefreshEnabled = this.checked;
            if (isAutoRefreshEnabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    }

    startAutoRefresh();
});

window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
